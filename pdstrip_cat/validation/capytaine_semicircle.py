#!/usr/bin/env python3
"""
Capytaine BEM script generated from pdstrip input files.

Source: Semi-circular cylinder barge R=1m L=20m for validation
Generated by pdstrip2capytaine.py

Geometry: 5 sections, sym=False, draft=1.000 m
Catamaran: False, hulld=0.000 m
Frequencies: 15 values (0.8276 to 4.5328 rad/s)
Wave directions: 3 values (-90.0 to 90.0 deg)

Usage:
    python capytaine_semicircle.py
"""

import numpy as np
import capytaine as cpt
import logging
import xarray as xr

cpt.set_logging(logging.WARNING)

# ============================================================
# Physical constants
# ============================================================
g = 9.81
rho = 1025.0
water_depth = np.inf

# ============================================================
# Frequencies and wave directions
# ============================================================
omega_values = np.array([
        0.827567, 0.938373, 1.058627, 1.170357, 1.327060, 1.483698, 1.673837, 1.904145,
        2.177473, 2.482701, 2.775744, 3.205153, 3.511070, 3.925495, 4.532771
])

wave_directions = np.array([
        -1.57079633, 0.00000000, 1.57079633
])
wave_directions_deg = np.array([
        -90.0, 0.0, 90.0
])

# ============================================================
# Hull mesh: 5 sections lofted into quad panels
# ============================================================
vertices = np.array([
    [-10.000000, -1.000000, 0.000000],
    [-10.000000, -0.987700, -0.156400],
    [-10.000000, -0.951100, -0.309000],
    [-10.000000, -0.891000, -0.454000],
    [-10.000000, -0.809000, -0.587800],
    [-10.000000, -0.707100, -0.707100],
    [-10.000000, -0.587800, -0.809000],
    [-10.000000, -0.454000, -0.891000],
    [-10.000000, -0.309000, -0.951100],
    [-10.000000, -0.156400, -0.987700],
    [-10.000000, 0.000000, -1.000000],
    [-10.000000, 0.156400, -0.987700],
    [-10.000000, 0.309000, -0.951100],
    [-10.000000, 0.454000, -0.891000],
    [-10.000000, 0.587800, -0.809000],
    [-10.000000, 0.707100, -0.707100],
    [-10.000000, 0.809000, -0.587800],
    [-10.000000, 0.891000, -0.454000],
    [-10.000000, 0.951100, -0.309000],
    [-10.000000, 0.987700, -0.156400],
    [-10.000000, 1.000000, 0.000000],
    [-5.000000, -1.000000, 0.000000],
    [-5.000000, -0.987700, -0.156400],
    [-5.000000, -0.951100, -0.309000],
    [-5.000000, -0.891000, -0.454000],
    [-5.000000, -0.809000, -0.587800],
    [-5.000000, -0.707100, -0.707100],
    [-5.000000, -0.587800, -0.809000],
    [-5.000000, -0.454000, -0.891000],
    [-5.000000, -0.309000, -0.951100],
    [-5.000000, -0.156400, -0.987700],
    [-5.000000, 0.000000, -1.000000],
    [-5.000000, 0.156400, -0.987700],
    [-5.000000, 0.309000, -0.951100],
    [-5.000000, 0.454000, -0.891000],
    [-5.000000, 0.587800, -0.809000],
    [-5.000000, 0.707100, -0.707100],
    [-5.000000, 0.809000, -0.587800],
    [-5.000000, 0.891000, -0.454000],
    [-5.000000, 0.951100, -0.309000],
    [-5.000000, 0.987700, -0.156400],
    [-5.000000, 1.000000, 0.000000],
    [0.000000, -1.000000, 0.000000],
    [0.000000, -0.987700, -0.156400],
    [0.000000, -0.951100, -0.309000],
    [0.000000, -0.891000, -0.454000],
    [0.000000, -0.809000, -0.587800],
    [0.000000, -0.707100, -0.707100],
    [0.000000, -0.587800, -0.809000],
    [0.000000, -0.454000, -0.891000],
    [0.000000, -0.309000, -0.951100],
    [0.000000, -0.156400, -0.987700],
    [0.000000, 0.000000, -1.000000],
    [0.000000, 0.156400, -0.987700],
    [0.000000, 0.309000, -0.951100],
    [0.000000, 0.454000, -0.891000],
    [0.000000, 0.587800, -0.809000],
    [0.000000, 0.707100, -0.707100],
    [0.000000, 0.809000, -0.587800],
    [0.000000, 0.891000, -0.454000],
    [0.000000, 0.951100, -0.309000],
    [0.000000, 0.987700, -0.156400],
    [0.000000, 1.000000, 0.000000],
    [5.000000, -1.000000, 0.000000],
    [5.000000, -0.987700, -0.156400],
    [5.000000, -0.951100, -0.309000],
    [5.000000, -0.891000, -0.454000],
    [5.000000, -0.809000, -0.587800],
    [5.000000, -0.707100, -0.707100],
    [5.000000, -0.587800, -0.809000],
    [5.000000, -0.454000, -0.891000],
    [5.000000, -0.309000, -0.951100],
    [5.000000, -0.156400, -0.987700],
    [5.000000, 0.000000, -1.000000],
    [5.000000, 0.156400, -0.987700],
    [5.000000, 0.309000, -0.951100],
    [5.000000, 0.454000, -0.891000],
    [5.000000, 0.587800, -0.809000],
    [5.000000, 0.707100, -0.707100],
    [5.000000, 0.809000, -0.587800],
    [5.000000, 0.891000, -0.454000],
    [5.000000, 0.951100, -0.309000],
    [5.000000, 0.987700, -0.156400],
    [5.000000, 1.000000, 0.000000],
    [10.000000, -1.000000, 0.000000],
    [10.000000, -0.987700, -0.156400],
    [10.000000, -0.951100, -0.309000],
    [10.000000, -0.891000, -0.454000],
    [10.000000, -0.809000, -0.587800],
    [10.000000, -0.707100, -0.707100],
    [10.000000, -0.587800, -0.809000],
    [10.000000, -0.454000, -0.891000],
    [10.000000, -0.309000, -0.951100],
    [10.000000, -0.156400, -0.987700],
    [10.000000, 0.000000, -1.000000],
    [10.000000, 0.156400, -0.987700],
    [10.000000, 0.309000, -0.951100],
    [10.000000, 0.454000, -0.891000],
    [10.000000, 0.587800, -0.809000],
    [10.000000, 0.707100, -0.707100],
    [10.000000, 0.809000, -0.587800],
    [10.000000, 0.891000, -0.454000],
    [10.000000, 0.951100, -0.309000],
    [10.000000, 0.987700, -0.156400],
    [10.000000, 1.000000, 0.000000],
])

faces = np.array([
    [0, 1, 22, 21],
    [1, 2, 23, 22],
    [2, 3, 24, 23],
    [3, 4, 25, 24],
    [4, 5, 26, 25],
    [5, 6, 27, 26],
    [6, 7, 28, 27],
    [7, 8, 29, 28],
    [8, 9, 30, 29],
    [9, 10, 31, 30],
    [10, 11, 32, 31],
    [11, 12, 33, 32],
    [12, 13, 34, 33],
    [13, 14, 35, 34],
    [14, 15, 36, 35],
    [15, 16, 37, 36],
    [16, 17, 38, 37],
    [17, 18, 39, 38],
    [18, 19, 40, 39],
    [19, 20, 41, 40],
    [21, 22, 43, 42],
    [22, 23, 44, 43],
    [23, 24, 45, 44],
    [24, 25, 46, 45],
    [25, 26, 47, 46],
    [26, 27, 48, 47],
    [27, 28, 49, 48],
    [28, 29, 50, 49],
    [29, 30, 51, 50],
    [30, 31, 52, 51],
    [31, 32, 53, 52],
    [32, 33, 54, 53],
    [33, 34, 55, 54],
    [34, 35, 56, 55],
    [35, 36, 57, 56],
    [36, 37, 58, 57],
    [37, 38, 59, 58],
    [38, 39, 60, 59],
    [39, 40, 61, 60],
    [40, 41, 62, 61],
    [42, 43, 64, 63],
    [43, 44, 65, 64],
    [44, 45, 66, 65],
    [45, 46, 67, 66],
    [46, 47, 68, 67],
    [47, 48, 69, 68],
    [48, 49, 70, 69],
    [49, 50, 71, 70],
    [50, 51, 72, 71],
    [51, 52, 73, 72],
    [52, 53, 74, 73],
    [53, 54, 75, 74],
    [54, 55, 76, 75],
    [55, 56, 77, 76],
    [56, 57, 78, 77],
    [57, 58, 79, 78],
    [58, 59, 80, 79],
    [59, 60, 81, 80],
    [60, 61, 82, 81],
    [61, 62, 83, 82],
    [63, 64, 85, 84],
    [64, 65, 86, 85],
    [65, 66, 87, 86],
    [66, 67, 88, 87],
    [67, 68, 89, 88],
    [68, 69, 90, 89],
    [69, 70, 91, 90],
    [70, 71, 92, 91],
    [71, 72, 93, 92],
    [72, 73, 94, 93],
    [73, 74, 95, 94],
    [74, 75, 96, 95],
    [75, 76, 97, 96],
    [76, 77, 98, 97],
    [77, 78, 99, 98],
    [78, 79, 100, 99],
    [79, 80, 101, 100],
    [80, 81, 102, 101],
    [81, 82, 103, 102],
    [82, 83, 104, 103],
])

print(f"Hull mesh: {vertices.shape[0]} vertices, {faces.shape[0]} quad faces")


# ============================================================
# Monohull body setup
# ============================================================
hull_mesh = cpt.Mesh(vertices=vertices, faces=faces, name='hull')

# Clip to below waterline
hull_mesh = hull_mesh.immersed_part(water_depth=np.inf)
print(f"Immersed mesh: {hull_mesh.nb_faces} faces")

# Add lid to suppress irregular frequencies
lid = hull_mesh.generate_lid(z=-0.0100)

body = cpt.FloatingBody(mesh=hull_mesh, lid_mesh=lid, name='vessel')
body.add_all_rigid_body_dofs()
print(f"Body DOFs: {list(body.dofs.keys())}")

# ============================================================
# Set up and solve BEM problems
# ============================================================
problems = []
for omega in omega_values:
    for dof in body.dofs:
        problems.append(cpt.RadiationProblem(
            body=body, radiating_dof=dof, omega=omega,
            water_depth=water_depth, rho=rho, g=g))
    for beta in wave_directions:
        problems.append(cpt.DiffractionProblem(
            body=body, wave_direction=beta, omega=omega,
            water_depth=water_depth, rho=rho, g=g))

print(f"Solving {len(problems)} BEM problems...")
solver = cpt.BEMSolver()
results = solver.solve_all(problems, progress_bar=True)

# Assemble into xarray dataset
dataset = cpt.assemble_dataset(results)

# ============================================================
# Save results
# ============================================================
# Save as numpy archive (avoids xarray/netCDF dtype issues with complex data)
output_file = 'capytaine_semicircle_results.npz'
np.savez(output_file,
    omega=omega_values,
    wave_directions=wave_directions,
    wave_directions_deg=wave_directions_deg,
    added_mass=dataset['added_mass'].values,
    radiation_damping=dataset['radiation_damping'].values,
    diffraction_force=dataset['diffraction_force'].values if 'diffraction_force' in dataset else np.array([]),
    Froude_Krylov_force=dataset['Froude_Krylov_force'].values if 'Froude_Krylov_force' in dataset else np.array([]),
    radiating_dofs=np.array(list(dataset.coords['radiating_dof'].values)),
    influenced_dofs=np.array(list(dataset.coords['influenced_dof'].values)),
    g=g, rho=rho, water_depth=np.inf,
)
print(f"Results saved to {output_file}")

# ============================================================
# Print summary table
# ============================================================
print("\n" + "="*70)
print("RESULTS SUMMARY")
print("="*70)
dofs = list(body.dofs.keys())
for dof in ['Surge', 'Sway', 'Heave', 'Roll', 'Pitch', 'Yaw'] + [d for d in dofs if '__' in d]:
    if dof not in dofs and not any(dof in d for d in dofs):
        continue
    # Find matching DOF name
    matches = [d for d in dofs if d == dof or d.endswith(dof)]
    for dof_name in matches[:1]:
        try:
            am = dataset['added_mass'].sel(radiating_dof=dof_name, influenced_dof=dof_name)
            rd = dataset['radiation_damping'].sel(radiating_dof=dof_name, influenced_dof=dof_name)
            print(f"\n{dof_name}:")
            print(f"  omega     added_mass      damping")
            for iw, w in enumerate(omega_values[:10]):
                a_val = float(am.sel(omega=w, method='nearest'))
                b_val = float(rd.sel(omega=w, method='nearest'))
                print(f"  {w:8.4f}  {a_val:14.4f}  {b_val:14.4f}")
            if len(omega_values) > 10:
                print(f"  ... ({len(omega_values) - 10} more frequencies)")
        except (KeyError, ValueError):
            pass

print("\nDone.")
